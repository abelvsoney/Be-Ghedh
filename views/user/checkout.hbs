<!DOCTYPE html>
<html lang="en">

<head>
	<title>Shoping Cart</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--===============================================================================================-->
	<link rel="icon" type="image/png" href="images/icons/favicon.png" />
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="fonts/linearicons-v1.0.0/icon-font.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="vendor/perfect-scrollbar/perfect-scrollbar.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="css/util.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<!--===============================================================================================-->
</head>

<body class="animsition">


	<center>
		<h3 class="mt-5 pt-5" style="text-decoration: underline;">Checkout</h3>
	</center>

	<!-- Shoping Cart -->
	<form class="bg0 p-t-75 p-b-85" id="checkout-form">
		<div class="container">
			<div class="row">
				<div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
					<div class="m-l-25 m-r--38 m-lr-0-xl">
						<div class="wrap-table-shopping-cart">
							<table class="table-shopping-cart">
								<tr class="table_head">
									<th class="column-1">Product</th>
									<th class="column-2"></th>
									<th class="column-3">Price</th>
									<th class="column-4">Quantity</th>
									<th class="column-5">Total</th>
								</tr>
								{{#each products}}
								<tr class="table_row">
									<td class="column-1">
										<button type="button" onclick="deleteFromCart('{{this.product._id}}')" disabled>
											<div class="how-itemcart1">
												<img src="{{this.product.img_url1}}" alt="IMG">
											</div>
										</button>
									</td>
									<td class="column-2">{{this.product.product_name}}</td>
									<td class="column-3">$ {{this.product.price}}</td>
									<td class="column-4">
										<div class="wrap-num-product flex-w m-l-auto m-r-0">
											<button type="button"
												onclick="changeQuantity('{{this._id}}', '{{this.product._id}}',-1)"
												disabled>
												<div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m">
													<i class="fs-16 zmdi zmdi-minus"></i>
												</div>
											</button>


											{{!-- <input class="mtext-104 cl3 txt-center num-product" type="number"
												name="num-product1" value={{this.quantity}}> --}}
											<span class="mtext-104 cl3 pt-2 txt-center num-product"
												id="{{this.product._id}}">{{this.quantity}}</span>

											<button type="button"
												onclick="changeQuantity('{{this._id}}','{{this.product._id}}',1)"
												disabled>
												<div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m">
													<i class="fs-16 zmdi zmdi-plus"></i>
												</div>
											</button>

										</div>
									</td>
									<td class="column-5">$ {{this.product.price}}</td>
								</tr>
								{{/each}}
							</table>
						</div>

						<div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
							<div class="flex-w flex-m m-r-20 m-tb-5">
								<input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text" placeholder="Coupon Code">
									{{!-- name="coupon"  --}}

								<div
									class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5">
									Apply coupon
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
					<div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
						<h4 class="mtext-109 cl2 p-b-30">
							Cart Totals
						</h4>



						<div class="flex-w flex-t p-t-27 p-b-33">
							<div class="size-208">
								<span class="mtext-101 cl2">
									Total:
								</span>
							</div>

							<div class="size-209 p-t-1">
								<span>$ </span>
								<span class="mtext-110 cl2" id="total">
									{{total}}
								</span>
							</div>
						</div>
						<a href="/checkout">
							<button class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer"
								type="submit" id="co">
								Place Order
							</button>
						</a>

					</div>
				</div>
			</div>
		</div>



	<!-- Shoping Cart -->
		<div class="container">
			<div class="row">
				<div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
					<div class="m-l-25 m-r--38 m-lr-0-xl">
						<div class="wrap-table-shopping-cart">
							<table class="table-shopping-cart">
								<tr class="table_head">
									<th class="column-1">Address</th>
									<th class="column-2"></th>
								</tr>
								{{#each addresses}}
								<tr class="table_row">
									<td class="column-1">
										<b><p>{{this.firstname}} {{this.secondname}}</p></b>
                                        <p style="inline-size: 133px; overflow-wrap:break-word;">{{this.address}},</p>
                                        <p>{{this.city}}, {{this.state}}</p>
                                        <p>{{this.pincode}}</p>
                                        <p>Ph No: {{this.number}}</p>
									</td>
									<td class="column-2">
										<input type="radio" id="addressId" name="addressId" value="{{this._id}}" required>
									</td>
								</tr>
								{{/each}}
							</table>
						</div>
					</div>
				</div>

				<div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
					<div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
						<h4 class="mtext-109 cl2 p-b-30">
							Payment Methods
						</h4>
						<span><label for="paymentmethod">COD</label></span>
						<input class="radio" type="radio" id="paymentmethod" name="paymentmethod" onclick="toggle()" value="COD" placeholder="COD" required>
						<span><label for="paymentmethod">Razorpay</label></span>
						<input type="radio" id="paymentmethod" name="paymentmethod" value="RazorPay" onclick="toggle()" placeholder="RazorPay" required>
						<span><label for="paymentmethod">Paypal</label></span>
						<input type="radio" id="paymentmethod" name="paymentmethod" value="Paypal" onclick="toggle1()" placeholder="Paypal" required>
						 <div class="btn clr" id="paypal-button-container"></div>
					</div>
				</div>
			</div>
		</div>
	</form>

	<!-- Back to top -->
	<div class="btn-back-to-top" id="myBtn">
		<span class="symbol-btn-back-to-top">
			<i class="zmdi zmdi-chevron-up"></i>
		</span>
	</div>


	{{!--
	<!--===============================================================================================-->
	<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/animsition/js/animsition.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/bootstrap/js/popper.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/select2/select2.min.js"></script>
	<script>
		$(".js-select2").each(function () {
			$(this).select2({
				minimumResultsForSearch: 20,
				dropdownParent: $(this).next('.dropDownSelect2')
			});
		})
	</script>
	<!--===============================================================================================-->
	<script src="vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
	<script>
		$('.js-pscroll').each(function () {
			$(this).css('position', 'relative');
			$(this).css('overflow', 'hidden');
			var ps = new PerfectScrollbar(this, {
				wheelSpeed: 1,
				scrollingThreshold: 1000,
				wheelPropagation: false,
			});

			$(window).on('resize', function () {
				ps.update();
			})
		});
	</script>

	<!--===============================================================================================-->
	<script src="js/main.js"></script> --}}
	<script src="https://www.paypal.com/sdk/js?client-id=AeTjm4FYz8xWt4Y2rFKVS1owi09C3HIFgR4Uc95oOHW1RCrJkFTvhOt43DCA4uKY0DNJSvMCp9henkSC&currency=USD"></script>

	<script>
		function changeQuantity(cartId, proId, count) {
			let quantity = parseInt(document.getElementById(proId).innerHTML)
			count = parseInt(count)

			$.ajax({
				url: '/changeproductquantity',
				data: {
					cart: cartId,
					product: proId,
					count: count,
					quantity: quantity
				},
				method: 'post',
				success: (response) => {
					if (response.status) {
						document.getElementById(proId).innerHTML = quantity + count
						document.getElementById("total").innerHTML = response.total
					} else if (response.removeProduct) {
						alert("Product removed from cart")
						location.reload()
					}
				}
			})
		}
	</script>
	<script>
		$("#checkout-form").submit((e) => {
			e.preventDefault()
			$.ajax({
				url:'/placeorder',
				method:'post',
				data:$('#checkout-form').serialize(),
				success:(response) => {
					alert(response)
					if(response.status === true) {
						location.href='/vieworders'
					} else if(response == "paypal"){
						location.href ='/vieworders'
					} else {
						console.log("inside else")
						razorpayPayment(response)
					}
				}
			})
		})

		function razorpayPayment(order) {
			var options = {
    "key": "rzp_test_eARPjl54RYSf66", // Enter the Key ID generated from the Dashboard
    "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Be Ghedh",
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
	"handler": function (res){
    alert(res.razorpay_payment_id);
    alert(res.razorpay_order_id);
    alert(res.razorpay_signature)
	
	verifyPayment(res, order)
	},
    "prefill": {
        "name": "Gaurav Kumar",
        "email": "gaurav.kumar@example.com",
        "contact": "9999999999"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};
	var rzp1 = new Razorpay(options)
		rzp1.open();
	}

	
	function verifyPayment(payment, order) {
		$.ajax({
			url:'/verifypayment',
			data:{
				payment,
				order
			},
			method:'post',
			success: (response) => {
				if(response.status) {
					location.href ='/ordersuccessful'
				} else {
					alert('Payment failed')
				}
			}
		})
	}	
	</script>
    <script>
      paypal.Buttons({
        // Order is created on the server and the order id is returned
        createOrder: (data, actions) => {
          return fetch("/api/orders", {
            method: "post",
            // use the "body" param to optionally pass additional order information
            // like product ids or amount
          })
          .then((response) => response.json())
          .then((order) => order.id);
        },
        // Finalize the transaction on the server after payer approval
        onApprove: (data, actions) => {
          return fetch(`/api/orders/${data.orderID}/capture`, {
            method: "post",
          })
          .then((response) => response.json())
          .then((orderData) => {
            // Successful capture! For dev/demo purposes:
            console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
            const transaction = orderData.purchase_units[0].payments.captures[0];
			  $( "#co" ).trigger( "click" );
            //alert(`Transaction ${transaction.status}: ${transaction.id}\n\nSee console for all available details`);
            // When ready to go live, remove the alert and show a success message within this page. For example:
            // const element = document.getElementById('paypal-button-container');
            // element.innerHTML = '<h3>Thank you for your payment!</h3>';
            // Or go to another URL:  actions.redirect('thank_you.html');
          });
        }
      }).render('#paypal-button-container');
    </script>
	<style>
  .clr {
    display: none !important;
  }
  .sft {
   display: block !important;
  }
</style>

	<script>
  function toggle() {
    const list = document.getElementById("co").classList;
    const list2 = document.getElementById("paypal-button-container").classList;
    list.add("sft");
    list2.remove("sft");
  
  }
   function toggle1() {
    const list = document.getElementById("co").classList;
    const list2 = document.getElementById("paypal-button-container").classList;
    list2.add("sft");
    list.remove("sft");
  }
</script>
</body>

</html>